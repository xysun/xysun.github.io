<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# " lang="en">
<head>
<meta charset="utf-8">
<base href="https://xysun.github.io/index.html">
<meta name="description" content="This is a demo site for Nikola.">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Do Nothing</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta content="#5670d4" name="theme-color">
<link rel="alternate" type="application/rss+xml" title="RSS" href="rss.xml">
<link rel="canonical" href="https://xysun.github.io/index.html">
<link rel="next" href="index-1.html" type="text/html">
<!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]--><link rel="prefetch" href="posts/design-pattern-6-command-pattern.html" type="text/html">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://xysun.github.io/">

                <span id="blog-title">Do Nothing</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="archive.html">Archive</a>
                </li>
<li>
<a href="stories/about.html">About</a>
                </li>
<li>
<a href="categories/index.html">Tags</a>
                </li>
<li>
<a href="rss.xml">RSS feed</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            

<div class="postindex">
    <article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="posts/design-pattern-6-command-pattern.html" class="u-url">Design Pattern #6: Command Pattern</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn">
                Xiayun Sun
            </span></p>
            <p class="dateline"><a href="posts/design-pattern-6-command-pattern.html" rel="bookmark"><time class="published dt-published" datetime="2015-11-15T20:08:34+08:00" title="2015-11-15 20:08">2015-11-15 20:08</time></a></p>
                <p class="commentline">
        
    <a href="posts/design-pattern-6-command-pattern.html#disqus_thread" data-disqus-identifier="cache/posts/design-pattern-6-command-pattern.html">Comments</a>


        </p>
</div>
    </header><div class="e-content entry-content">
    <div>
<p>These are my notes about the book Head First Design Patterns.</p>
<h3>Example problem</h3>
<p>Home automation remote control: on, off, undo. Supporting extensible commands.</p>
<h3>Cook example</h3>
<ul>
<li>Customer &lt;--&gt; <code>Client</code>: customer create command object and call <code>setCommand</code> on invoker</li>
<li>Order &lt;--&gt; <code>Command</code>
</li>
<li>Waitress &lt;--&gt; <code>Invoker</code>: can call <code>execute</code> on the command objects.</li>
<li>Cook &lt;--&gt; <code>Receiver</code>
</li>
</ul>
<pre class="code literal-block"><span class="k">class</span> <span class="nc">Order</span><span class="o">(</span><span class="n">cook</span><span class="k">:</span><span class="kt">Cook</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// hold reference to the actual "actor"</span>

  <span class="k">def</span> <span class="n">orderUp</span><span class="o">()</span> <span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span> <span class="c1">// interface that encapsulates the action</span>
    <span class="n">cook</span><span class="o">.</span><span class="n">makeBurger</span> <span class="c1">// can vary among different command objects</span>
  <span class="o">}</span>

<span class="o">}</span>
</pre>


<h3>Simple remote control with one slot</h3>
<pre class="code literal-block"><span class="k">abstract</span> <span class="k">class</span> <span class="nc">Command</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">execute</span><span class="k">:</span><span class="kt">Unit</span>
<span class="o">}</span>

<span class="k">class</span> <span class="nc">LightOnCommand</span><span class="o">(</span><span class="n">light</span><span class="k">:</span><span class="kt">Light</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">Command</span><span class="o">{</span> <span class="c1">// command object</span>
  <span class="k">def</span> <span class="n">execute</span> <span class="k">=</span> <span class="n">light</span><span class="o">.</span><span class="n">on</span>
<span class="o">}</span>

<span class="k">class</span> <span class="nc">RemoteControl</span><span class="o">{</span> <span class="c1">// invoker</span>
  <span class="k">var</span> <span class="n">slot</span><span class="k">:</span><span class="kt">Command</span> <span class="o">=</span> <span class="kc">null</span>

  <span class="k">def</span> <span class="n">setCommand</span><span class="o">(</span><span class="n">cmd</span><span class="k">:</span><span class="kt">Command</span><span class="o">)</span><span class="k">:</span><span class="kt">Unit</span> <span class="o">=</span> <span class="n">slot</span> <span class="k">=</span> <span class="n">cmd</span>

  <span class="k">def</span> <span class="n">buttonPressed</span><span class="k">:</span><span class="kt">Unit</span> <span class="o">=</span> <span class="n">slot</span><span class="o">.</span><span class="n">execute</span>
<span class="o">}</span>

<span class="k">object</span> <span class="nc">Main</span><span class="o">{</span> <span class="c1">// client</span>
  <span class="k">def</span> <span class="n">main</span><span class="o">(</span><span class="n">args</span><span class="k">:</span><span class="kt">Array</span><span class="o">[</span><span class="kt">String</span><span class="o">])</span><span class="k">:</span><span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
    <span class="k">val</span> <span class="n">control</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">RemoteControl</span>
    <span class="n">control</span><span class="o">.</span><span class="n">setCommand</span><span class="o">(</span><span class="k">new</span> <span class="nc">LightOnCommand</span><span class="o">(</span><span class="k">new</span> <span class="nc">Light</span><span class="o">))</span>
    <span class="n">control</span><span class="o">.</span><span class="n">buttonPressed</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre>


<h3>Support undo:</h3>
<p>Keep track of last command called.</p>
<pre class="code literal-block"><span class="c1">// NOTE: these are NOT gramatically correct</span>

<span class="k">abstract</span> <span class="k">class</span> <span class="nc">Command</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">execute</span><span class="k">:</span><span class="kt">Unit</span>
  <span class="k">def</span> <span class="n">undo</span><span class="k">:</span><span class="kt">Unit</span>
<span class="o">}</span>

<span class="k">class</span> <span class="nc">LightOnCommand</span><span class="o">(</span><span class="n">light</span><span class="k">:</span><span class="kt">Light</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">Command</span><span class="o">{</span> <span class="c1">// command object</span>
  <span class="k">def</span> <span class="n">execute</span> <span class="k">=</span> <span class="n">light</span><span class="o">.</span><span class="n">on</span>
  <span class="k">def</span> <span class="n">undo</span> <span class="k">=</span> <span class="n">light</span><span class="o">.</span><span class="n">off</span>
<span class="o">}</span>

<span class="k">class</span> <span class="nc">RemoteControl</span><span class="o">{</span> <span class="c1">// invoker</span>
  <span class="k">val</span> <span class="n">slots</span><span class="k">:</span><span class="kt">Seq</span><span class="o">[</span><span class="kt">Command</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Nil</span>

  <span class="k">var</span> <span class="n">undoCommand</span><span class="k">:</span><span class="kt">Command</span> <span class="o">=</span> <span class="nc">NoCommand</span>

  <span class="k">def</span> <span class="n">setCommand</span><span class="o">(</span><span class="n">i</span><span class="k">:</span><span class="kt">Int</span><span class="o">,</span> <span class="n">cmd</span><span class="k">:</span><span class="kt">Command</span><span class="o">)</span><span class="k">:</span><span class="kt">Unit</span> <span class="o">=</span> <span class="n">slots</span><span class="o">[</span><span class="kt">i</span><span class="o">]</span> <span class="k">=</span> <span class="n">cmd</span>

  <span class="k">def</span> <span class="n">buttonPressed</span><span class="o">(</span><span class="n">i</span><span class="k">:</span><span class="kt">Int</span><span class="o">)</span><span class="k">:</span><span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
    <span class="n">slots</span><span class="o">(</span><span class="n">i</span><span class="o">).</span><span class="n">execute</span>
    <span class="n">undoCommand</span> <span class="k">=</span> <span class="n">slots</span><span class="o">(</span><span class="n">i</span><span class="o">)</span> <span class="c1">// keep track of last command </span>
  <span class="o">}</span>

  <span class="k">def</span> <span class="n">undo</span> <span class="k">=</span> <span class="n">undoCommand</span><span class="o">.</span><span class="n">undo</span>
<span class="o">}</span>
</pre>


<p>To support a history of undos, keep a stack. </p>
<h3>Use a macro command</h3>
<pre class="code literal-block"><span class="k">class</span> <span class="nc">MacroCommand</span><span class="o">(</span><span class="n">commands</span><span class="k">:</span><span class="kt">Seq</span><span class="o">[</span><span class="kt">Command</span><span class="o">])</span> <span class="k">extends</span> <span class="nc">Command</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">execute</span> <span class="k">=</span> <span class="n">commands</span><span class="o">.</span><span class="n">foreach</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">execute</span><span class="o">)</span>
<span class="o">}</span>
</pre>


<h3>Definition</h3>
<ul>
<li>Encapsulating a request as an object. Decouple the requester of an action from the object that actually performs the action.</li>
<li>"Store them, pass them around, and invoke them when you need them"</li>
<li>Roles:<ul>
<li>Client: create a concrete command and set its receiver</li>
<li>Invoker: holds a command and call its <code>execute</code> method</li>
<li>Receiver: know how to carry out the request</li>
<li>Command: provide <code>execute</code> (and <code>undo</code>) method. Bind together a set of actions on a specific receiver.</li>
</ul>
</li>
</ul>
<h3>Others</h3>
<ul>
<li>Implementing a <code>NoCommand</code> can be useful (no need to check <code>null</code> any more). aka "null object" (better handled by <code>Option</code> type in scala)</li>
<li>More usages:<ul>
<li>Job queues: have a group of threads sit on end of the queue, retrieve a command object, call its <code>execute</code> method.</li>
<li>Logging requests: as we execute commands, we store a history of them on disk (command object supports <code>save</code> method). When a crash occurs, we reload the command objects (<code>reload</code> method of command object) and invoke <code>execute</code> in order. --&gt; can support all-or-nothing transaction.</li>
</ul>
</li>
</ul>
</div>
    </div>
    </article><article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="posts/design-pattern-5-singleton-pattern.html" class="u-url">Design Pattern #5: Singleton Pattern</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn">
                Xiayun Sun
            </span></p>
            <p class="dateline"><a href="posts/design-pattern-5-singleton-pattern.html" rel="bookmark"><time class="published dt-published" datetime="2015-11-14T15:48:26+08:00" title="2015-11-14 15:48">2015-11-14 15:48</time></a></p>
                <p class="commentline">
        
    <a href="posts/design-pattern-5-singleton-pattern.html#disqus_thread" data-disqus-identifier="cache/posts/design-pattern-5-singleton-pattern.html">Comments</a>


        </p>
</div>
    </header><div class="e-content entry-content">
    <div>
<p>These are my notes about the book Head First Design Patterns.</p>
<h3>Definition:</h3>
<ul>
<li>
<p>Ensure one and only one object is instantiated for a given class, and provides a global point of access. </p>
</li>
<li>
<p>Example usage: global resources like connection/thread pools</p>
</li>
<li>
<p>For resource intensive objects, can implemented in lazy manner.</p>
</li>
</ul>
<h3>Java implementation:</h3>
<p>Use a private constructor.</p>
<pre class="code literal-block"><span class="cm">/**</span>
<span class="cm"> * Created by jsun on 11/14/2015 AD.</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Singleton</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="n">Singleton</span> <span class="n">uniqueInstance</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

    <span class="kd">private</span> <span class="nf">Singleton</span><span class="o">(){};</span>

    <span class="c1">// NOT THREAD SAFE!</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">Singleton</span> <span class="nf">getInstance</span><span class="o">()</span> <span class="o">{</span> <span class="c1">// others have to call this method to get instance</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">uniqueInstance</span> <span class="o">==</span> <span class="kc">null</span><span class="o">){</span>
            <span class="n">uniqueInstance</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Singleton</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">uniqueInstance</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// other methods below</span>

<span class="o">}</span>
</pre>


<h3>To be thread safe</h3>
<ul>
<li>Use <code>synchronized</code>. Expensive (can decrease performance by 100x) and we actually only need to synchronize during the first time.</li>
</ul>
<pre class="code literal-block"><span class="kd">public</span> <span class="kd">static</span> <span class="kd">synchronized</span> <span class="n">Singleton</span> <span class="nf">getInstance</span><span class="o">()</span>
</pre>


<ul>
<li>Create eagerly</li>
</ul>
<p>JVM will ensure instance created before any thread access.</p>
<pre class="code literal-block"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Singleton</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="n">Singleton</span> <span class="n">uniqueInstance</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Singleton</span><span class="o">();</span>

    <span class="kd">private</span> <span class="nf">Singleton</span><span class="o">(){};</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">Singleton</span> <span class="nf">getInstance</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">uniqueInstance</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre>


<ul>
<li>Double checked locking: only synchronize if instance is not created yet.</li>
</ul>
<pre class="code literal-block"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Singleton</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">volatile</span> <span class="kd">static</span> <span class="n">Singleton</span> <span class="n">uniqueInstance</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Singleton</span><span class="o">();</span>

    <span class="kd">private</span> <span class="nf">Singleton</span><span class="o">(){};</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">Singleton</span> <span class="nf">getInstance</span><span class="o">()</span> <span class="o">{</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">uniqueInstance</span> <span class="o">==</span> <span class="kc">null</span><span class="o">){</span>
            <span class="kd">synchronized</span> <span class="o">(</span><span class="n">Singleton</span><span class="o">.</span><span class="na">class</span><span class="o">){</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">uniqueInstance</span> <span class="o">==</span> <span class="kc">null</span><span class="o">){</span> <span class="c1">// check again</span>
                    <span class="n">uniqueInstance</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Singleton</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">uniqueInstance</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre>


<h3>Scala:</h3>
<ul>
<li>Scala has native support for singleton: <code>Object</code>.</li>
</ul>
</div>
    </div>
    </article><article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="posts/design-pattern-4-factory-pattern.html" class="u-url">Design Pattern #4: Factory Pattern</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn">
                Xiayun Sun
            </span></p>
            <p class="dateline"><a href="posts/design-pattern-4-factory-pattern.html" rel="bookmark"><time class="published dt-published" datetime="2015-11-10T21:43:45+08:00" title="2015-11-10 21:43">2015-11-10 21:43</time></a></p>
                <p class="commentline">
        
    <a href="posts/design-pattern-4-factory-pattern.html#disqus_thread" data-disqus-identifier="cache/posts/design-pattern-4-factory-pattern.html">Comments</a>


        </p>
</div>
    </header><div class="e-content entry-content">
    <div>
<h3>Example problem: pizza shop</h3>
<pre class="code literal-block">  <span class="c1">// this code will need to change if pizza types change in the future</span>
  <span class="c1">// i.e not "closed for modification"</span>

  <span class="k">def</span> <span class="n">orderPizza</span><span class="o">(</span><span class="n">pizzaType</span><span class="k">:</span><span class="kt">String</span><span class="o">)</span><span class="k">:</span><span class="kt">Pizza</span> <span class="o">=</span> <span class="o">{</span> <span class="c1">// Pizza is a trait or abstract class</span>
    <span class="k">val</span> <span class="n">pizza</span> <span class="k">=</span> <span class="n">pizzaType</span> <span class="k">match</span> <span class="o">{</span>
      <span class="k">case</span> <span class="s">"cheese"</span> <span class="k">=&gt;</span> <span class="k">new</span> <span class="nc">CheesePizza</span>
      <span class="k">case</span> <span class="s">"greek"</span> <span class="k">=&gt;</span> <span class="k">new</span> <span class="nc">GreekPizza</span>
      <span class="k">case</span> <span class="s">"pepperoni"</span> <span class="k">=&gt;</span> <span class="k">new</span> <span class="nc">PepperoniPizza</span>
    <span class="o">}</span>

    <span class="n">pizza</span><span class="o">.</span><span class="n">prepare</span><span class="o">()</span>
    <span class="n">pizza</span><span class="o">.</span><span class="n">bake</span><span class="o">()</span>
    <span class="n">pizza</span><span class="o">.</span><span class="n">cut</span><span class="o">()</span>
    <span class="n">pizza</span><span class="o">.</span><span class="n">box</span><span class="o">()</span>

    <span class="n">pizza</span>
</pre>


<h3>"Simple Factory Pattern"</h3>
<ul>
<li>Use an object to handle object creation.</li>
<li>One implementation with no subclassing.</li>
</ul>
<pre class="code literal-block"><span class="k">class</span> <span class="nc">SimplePizzaFactory</span><span class="o">{</span>

  <span class="k">def</span> <span class="n">createPizza</span><span class="o">(</span><span class="n">pizzaType</span><span class="k">:</span><span class="kt">String</span><span class="o">)</span><span class="k">:</span><span class="kt">Pizza</span> <span class="o">=</span>
    <span class="n">pizzaType</span> <span class="k">match</span> <span class="o">{</span>
      <span class="k">case</span> <span class="s">"cheese"</span> <span class="k">=&gt;</span> <span class="k">new</span> <span class="nc">CheesePizza</span>
      <span class="k">case</span> <span class="s">"greek"</span> <span class="k">=&gt;</span> <span class="k">new</span> <span class="nc">GreekPizza</span>
      <span class="k">case</span> <span class="s">"pepperoni"</span> <span class="k">=&gt;</span> <span class="k">new</span> <span class="nc">PepperoniPizza</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="c1">// we pass factory in constructor</span>
<span class="k">class</span> <span class="nc">PizzaShop</span><span class="o">(</span><span class="n">factory</span><span class="k">:</span> <span class="kt">SimplePizzaFactory</span><span class="o">)</span> <span class="o">{</span>

  <span class="k">def</span> <span class="n">orderPizza</span><span class="o">(</span><span class="n">pizzaType</span><span class="k">:</span><span class="kt">String</span><span class="o">)</span><span class="k">:</span><span class="kt">Pizza</span> <span class="o">=</span> <span class="o">{</span>

    <span class="k">val</span> <span class="n">pizza</span> <span class="k">=</span> <span class="n">factory</span><span class="o">.</span><span class="n">createPizza</span><span class="o">(</span><span class="n">pizzaType</span><span class="o">)</span>

    <span class="n">pizza</span><span class="o">.</span><span class="n">prepare</span><span class="o">()</span>
    <span class="n">pizza</span><span class="o">.</span><span class="n">bake</span><span class="o">()</span>
    <span class="n">pizza</span><span class="o">.</span><span class="n">cut</span><span class="o">()</span>
    <span class="n">pizza</span><span class="o">.</span><span class="n">box</span><span class="o">()</span>

    <span class="n">pizza</span>

  <span class="o">}</span>
<span class="o">}</span>
</pre>


<p>The Good:</p>
<ul>
<li>Object creation is now encapsulated. </li>
<li>Multiple instances can share one same factory. </li>
</ul>
<p>What if we need multiple factories? </p>
<pre class="code literal-block"><span class="k">val</span> <span class="n">nyPizzaFactory</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">NYPizzaFactory</span> <span class="c1">// extends SimplePizzaFactory</span>
<span class="k">val</span> <span class="n">nyPizzaStore</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">PizzaShop</span><span class="o">(</span><span class="n">nyPizzaFactory</span><span class="o">)</span>

<span class="k">val</span> <span class="n">chicagoPizzaFactory</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">ChicagoPizzaFactory</span>
<span class="k">val</span> <span class="n">chicagoPizzaStore</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">PizzaShop</span><span class="o">(</span><span class="n">chicagoPizzaStore</span><span class="o">)</span>
</pre>


<p>hmm...</p>
<h3>Factory Method Pattern</h3>
<pre class="code literal-block"><span class="cm">/**</span>
<span class="cm"> * Created by jsun on 11/10/2015 AD.</span>
<span class="cm"> */</span>

<span class="k">abstract</span> <span class="k">class</span> <span class="nc">Pizza</span><span class="o">{</span>
  <span class="k">def</span> <span class="n">prepare</span><span class="k">:</span><span class="kt">Unit</span>
  <span class="k">def</span> <span class="n">bake</span><span class="k">:</span><span class="kt">Unit</span>
  <span class="k">def</span> <span class="n">cut</span><span class="k">:</span><span class="kt">Unit</span>
  <span class="k">def</span> <span class="n">box</span><span class="k">:</span><span class="kt">Unit</span>
<span class="o">}</span>

<span class="c1">// we pass factory in constructor</span>
<span class="k">abstract</span> <span class="k">class</span> <span class="nc">PizzaShop</span> <span class="o">{</span>

  <span class="k">def</span> <span class="n">createPizza</span><span class="o">(</span><span class="n">pizzaType</span><span class="k">:</span><span class="kt">String</span><span class="o">)</span><span class="k">:</span><span class="kt">Pizza</span> <span class="c1">// subclass must implement this "factory method"</span>

  <span class="k">def</span> <span class="n">orderPizza</span><span class="o">(</span><span class="n">pizzaType</span><span class="k">:</span><span class="kt">String</span><span class="o">)</span><span class="k">:</span><span class="kt">Pizza</span> <span class="o">=</span> <span class="o">{</span>

    <span class="k">val</span> <span class="n">pizza</span> <span class="k">=</span> <span class="n">createPizza</span><span class="o">(</span><span class="n">pizzaType</span><span class="o">)</span>

    <span class="c1">// the rest procedures are localized and will be consistent</span>

    <span class="n">pizza</span><span class="o">.</span><span class="n">prepare</span>
    <span class="n">pizza</span><span class="o">.</span><span class="n">bake</span>
    <span class="n">pizza</span><span class="o">.</span><span class="n">cut</span>
    <span class="n">pizza</span><span class="o">.</span><span class="n">box</span>

    <span class="n">pizza</span>

  <span class="o">}</span>
<span class="o">}</span>


<span class="k">class</span> <span class="nc">NYPizzaShop</span> <span class="k">extends</span> <span class="nc">PizzaShop</span><span class="o">{</span>
  <span class="k">def</span> <span class="n">createPizza</span><span class="o">(</span><span class="n">pizzaType</span><span class="k">:</span><span class="kt">String</span><span class="o">)</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">NYPizza</span>
<span class="o">}</span>
</pre>


<ul>
<li>Defer object creation to subclass</li>
<li>Can localize other procedures (eg. <code>prepare</code>, <code>bake</code>, <code>cut</code>, <code>box</code>)</li>
<li>
<code>Creator</code> class (PizzaShop) + <code>Product</code> class (Pizza). "Parallel classes"</li>
<li>However, creating <em>one</em> product only.</li>
</ul>
<p>Now what if you have different families of pizza ingredients? </p>
<h3>Abstract Factory Pattern</h3>
<pre class="code literal-block"><span class="c1">// "abstract factory"</span>
<span class="k">abstract</span> <span class="k">class</span> <span class="nc">PizzaIngredientFactory</span><span class="o">{</span>
  <span class="k">def</span> <span class="n">createDough</span><span class="k">:</span><span class="kt">Dough</span> <span class="c1">// "Factory Methods"</span>
  <span class="k">def</span> <span class="n">createSauce</span><span class="k">:</span><span class="kt">Sauce</span>
  <span class="c1">// will need to change interface if new ingredients are being added</span>
<span class="o">}</span>

<span class="c1">// concrete factory</span>
<span class="k">class</span> <span class="nc">NYIngredientFactory</span> <span class="k">extends</span> <span class="nc">PizzaIngredientFactory</span><span class="o">{</span>
  <span class="k">def</span> <span class="n">createDough</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">ThinCrustDough</span>
  <span class="k">def</span> <span class="n">createSauce</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">MarinaraSauce</span>
<span class="o">}</span>


<span class="k">abstract</span> <span class="k">class</span> <span class="nc">Pizza</span><span class="o">{</span>
  <span class="k">var</span> <span class="n">dough</span><span class="k">:</span><span class="kt">Dough</span>
  <span class="k">var</span> <span class="n">sauce</span><span class="k">:</span><span class="kt">Sauce</span>

  <span class="k">def</span> <span class="n">prepare</span><span class="k">:</span><span class="kt">Unit</span>
  <span class="k">def</span> <span class="n">bake</span><span class="k">:</span><span class="kt">Unit</span>
  <span class="k">def</span> <span class="n">cut</span><span class="k">:</span><span class="kt">Unit</span>
  <span class="k">def</span> <span class="n">box</span><span class="k">:</span><span class="kt">Unit</span>
<span class="o">}</span>

<span class="c1">// use concrete factories through composition</span>
<span class="k">class</span> <span class="nc">CheesePizza</span><span class="o">(</span><span class="n">ingredientFactory</span><span class="k">:</span> <span class="kt">PizzaIngredientFactory</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">Pizza</span><span class="o">{</span>

  <span class="n">dough</span> <span class="k">=</span> <span class="n">ingredientFactory</span><span class="o">.</span><span class="n">createDough</span>
  <span class="n">sauce</span> <span class="k">=</span> <span class="n">ingredientFactory</span><span class="o">.</span><span class="n">createSauce</span>

<span class="o">}</span>

<span class="k">class</span> <span class="nc">NYPizzaShop</span> <span class="k">extends</span> <span class="nc">PizzaShop</span><span class="o">{</span>

  <span class="k">def</span> <span class="n">createPizza</span><span class="o">(</span><span class="n">pizzaType</span><span class="k">:</span><span class="kt">String</span><span class="o">)</span> <span class="k">=</span> <span class="o">{</span>
    <span class="k">val</span> <span class="n">ingredientFactory</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">NYIngredientFactory</span>
    <span class="n">pizzaType</span> <span class="k">match</span> <span class="o">{</span>
      <span class="k">case</span> <span class="s">"cheese"</span> <span class="k">=&gt;</span> <span class="k">new</span> <span class="nc">CheesePizza</span><span class="o">(</span><span class="n">ingredientFactory</span><span class="o">)</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre>


<ul>
<li>For multiple families of object</li>
<li>Definition: create families of related or dependent objects (pizza ingredients here)  without specifying their concrete classes.</li>
</ul>
<h3>Design Principle (Dependency Inversion Principle)</h3>
<ul>
<li>
<p>Depend upon abstractions. Do not depend upon concrete classes. </p>
</li>
<li>
<p>No variables should hold a reference to a concrete class. (eg. using <code>new</code>)</p>
</li>
<li>
<p>No class should derive from a concrete class.</p>
</li>
<li>
<p>No method should override an implemented method of any of its base classes.</p>
</li>
</ul>
<h3>Reference</h3>
<ul>
<li><a href="https://web.cs.dal.ca/~jin/3132/lectures/dp-07.pdf">https://web.cs.dal.ca/~jin/3132/lectures/dp-07.pdf</a></li>
<li><a href="http://stackoverflow.com/questions/13029261/design-patterns-factory-vs-factory-method-vs-abstract-factory">http://stackoverflow.com/questions/13029261/design-patterns-factory-vs-factory-method-vs-abstract-factory</a></li>
<li><a href="http://corey.quickshiftconsulting.com/blog/first-post">http://corey.quickshiftconsulting.com/blog/first-post</a></li>
</ul>
</div>
    </div>
    </article><article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="posts/design-pattern-3-decorator-pattern.html" class="u-url">Design Pattern #3: Decorator Pattern</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn">
                Xiayun Sun
            </span></p>
            <p class="dateline"><a href="posts/design-pattern-3-decorator-pattern.html" rel="bookmark"><time class="published dt-published" datetime="2015-11-07T15:48:40+08:00" title="2015-11-07 15:48">2015-11-07 15:48</time></a></p>
                <p class="commentline">
        
    <a href="posts/design-pattern-3-decorator-pattern.html#disqus_thread" data-disqus-identifier="cache/posts/design-pattern-3-decorator-pattern.html">Comments</a>


        </p>
</div>
    </header><div class="e-content entry-content">
    <div>
<p>These are my notes for the book Head first design patterns. </p>
<h3>Overview</h3>
<ul>
<li>Give objects new responsibilities without making any code changes to the underlying class, even at runtime.</li>
</ul>
<h3>Example problem</h3>
<ul>
<li>
<p>Starbuzz's <code>cost()</code> function for beverage + condiments combinations</p>
</li>
<li>
<p>Solution: </p>
</li>
</ul>
<pre class="code literal-block"><span class="cm">/**</span>
<span class="cm"> * Created by jsun on 11/7/2015 AD.</span>
<span class="cm"> */</span>
<span class="k">abstract</span> <span class="k">class</span> <span class="nc">Beverage</span> <span class="o">{</span> <span class="c1">// abstract component</span>
  <span class="k">def</span> <span class="n">cost</span><span class="k">:</span><span class="kt">Double</span>
<span class="o">}</span>

<span class="k">class</span> <span class="nc">DarkRoast</span> <span class="k">extends</span> <span class="nc">Beverage</span><span class="o">{</span> <span class="c1">// concrete component</span>
  <span class="k">def</span> <span class="n">cost</span> <span class="k">=</span> <span class="mf">2.00</span>
<span class="o">}</span>

<span class="c1">// we pass in the decorated object in constructor; decorator object is like a wrapper</span>
<span class="c1">// decorator object mirror the types of decorated object (both extends Beverage here)</span>
<span class="c1">// a class for condiments only --&gt; not really necessary? </span>
<span class="k">abstract</span> <span class="k">class</span> <span class="nc">CondimentDecorator</span><span class="o">(</span><span class="n">beverage</span><span class="k">:</span> <span class="kt">Beverage</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">Beverage</span> <span class="c1">// abstract decorator</span>

<span class="k">class</span> <span class="nc">Mocha</span><span class="o">(</span><span class="n">beverage</span><span class="k">:</span> <span class="kt">Beverage</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">CondimentDecorator</span><span class="o">(</span><span class="n">beverage</span><span class="o">){</span>
  <span class="k">def</span> <span class="n">cost</span> <span class="k">=</span> <span class="mf">0.5</span> <span class="o">+</span> <span class="n">beverage</span><span class="o">.</span><span class="n">cost</span> <span class="c1">// "composing" behaviors</span>
<span class="o">}</span>

<span class="k">class</span> <span class="nc">Whip</span><span class="o">(</span><span class="n">beverage</span><span class="k">:</span> <span class="kt">Beverage</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">CondimentDecorator</span><span class="o">(</span><span class="n">beverage</span><span class="o">){</span>
  <span class="k">def</span> <span class="n">cost</span> <span class="k">=</span> <span class="mf">0.2</span> <span class="o">+</span> <span class="n">beverage</span><span class="o">.</span><span class="n">cost</span>
<span class="o">}</span>

<span class="k">object</span> <span class="nc">Main</span><span class="o">{</span>
  <span class="k">def</span> <span class="n">main</span><span class="o">(</span><span class="n">args</span><span class="k">:</span><span class="kt">Array</span><span class="o">[</span><span class="kt">String</span><span class="o">])</span><span class="k">:</span><span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
    <span class="k">val</span> <span class="n">drink</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Whip</span><span class="o">(</span><span class="k">new</span> <span class="nc">Mocha</span><span class="o">(</span><span class="k">new</span> <span class="nc">DarkRoast</span><span class="o">))</span>
    <span class="n">println</span><span class="o">(</span><span class="n">drink</span><span class="o">.</span><span class="n">cost</span><span class="o">)</span> <span class="c1">// 2 + 0.5 + 0.2 = 2.7</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre>


<h3>Decorator Pattern</h3>
<ul>
<li>
<p>The Decorator Pattern attached additional responsibilities to an object dynamically. Decorators provide a flexible alternative to subclassing for extending functionality.</p>
</li>
<li>
<p>Decorators have the same supertype as decorated.</p>
</li>
<li>
<p>Each decorator HAS-A a component, i.e the decorator has an instance variable that holds a reference to a component</p>
</li>
<li>
<p>Decorators are typically created by using other patterns like Factory and Builder.</p>
</li>
<li>
<p>Downside: often result in a large number of small classes that can be overwhelming; can increase component instantiation complexity (can be mitigated by Factory/Builder pattern)</p>
</li>
<li>
<p>Basically "wrappers"</p>
</li>
</ul>
<h3>Design Principle</h3>
<ul>
<li>Classes should be open for extension, but closed for modification. Concentrate on areas that are most likely to change in the future.</li>
</ul>
<h3>Example in real life: <code>java.io</code> package</h3>
<ul>
<li>all decorators: eg. <code>LineNumberInputStream</code> -&gt; <code>BufferedInputStream</code> -&gt; <code>FileInputStream</code>
</li>
<li>abstract component: <code>InpustStream</code>
</li>
<li>concrete component: <code>FileInputStream</code>, <code>StringBufferInputStream</code>, etc</li>
<li>abstract decorator: <code>FilterInputStream</code>
</li>
<li>concrete decorator: <code>BufferedInputStream</code>, <code>LineNumberInputStream</code>, etc.</li>
</ul>
<h3>Scala</h3>
<ul>
<li>Use <code>implicits</code> to add behavior without changing original class code (not runtime though)</li>
</ul>
<pre class="code literal-block"><span class="k">object</span> <span class="nc">ExtendedModels</span><span class="o">{</span>
  <span class="k">implicit</span> <span class="k">class</span> <span class="nc">ExtendedBeverage</span><span class="o">(</span><span class="n">beverage</span><span class="k">:</span> <span class="kt">Beverage</span><span class="o">){</span>
    <span class="k">def</span> <span class="n">costWithMilk</span> <span class="k">=</span> <span class="mf">0.2</span> <span class="o">+</span> <span class="n">beverage</span><span class="o">.</span><span class="n">cost</span> <span class="c1">// Beverage now has a costWithMilk() method, not the best example</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre>
</div>
    </div>
    </article><article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="posts/design-pattern-2-observer-pattern.html" class="u-url">Design Pattern #2: Observer Pattern</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn">
                Xiayun Sun
            </span></p>
            <p class="dateline"><a href="posts/design-pattern-2-observer-pattern.html" rel="bookmark"><time class="published dt-published" datetime="2015-10-26T20:55:32+08:00" title="2015-10-26 20:55">2015-10-26 20:55</time></a></p>
                <p class="commentline">
        
    <a href="posts/design-pattern-2-observer-pattern.html#disqus_thread" data-disqus-identifier="cache/posts/design-pattern-2-observer-pattern.html">Comments</a>


        </p>
</div>
    </header><div class="e-content entry-content">
    <div>
<h3>Overview</h3>
<p>observer pattern = publisher + subscriber</p>
<h3>Pattern definition:</h3>
<p>The observer pattern defines a one-to-many dependency between objects so that when one object changes stats, all of its dependents are notified and updated automatically.</p>
<h3>Starting example: weather monitoring application</h3>
<pre class="code literal-block"><span class="k">class</span> <span class="nc">WeatherStation</span> <span class="o">{</span>

  <span class="k">def</span> <span class="n">measurementsChanged</span><span class="o">()</span><span class="k">:</span><span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
    <span class="k">val</span> <span class="n">temp</span> <span class="k">=</span> <span class="n">getTemperature</span>
    <span class="k">val</span> <span class="n">humidity</span> <span class="k">=</span> <span class="n">getHumidity</span>
    <span class="k">val</span> <span class="n">pressure</span> <span class="k">=</span> <span class="n">getPressure</span>

    <span class="c1">// we want to make the displays extensible (i.e. decouple them), also maybe subscribe/unsubscribe during runtime</span>
    <span class="n">currentConditionsDisplay</span><span class="o">.</span><span class="n">update</span><span class="o">(</span><span class="n">temp</span><span class="o">,</span> <span class="n">humidity</span><span class="o">,</span> <span class="n">pressure</span><span class="o">)</span>
    <span class="n">statisticsDisplay</span><span class="o">.</span><span class="n">update</span><span class="o">(</span><span class="n">temp</span><span class="o">,</span> <span class="n">humidity</span><span class="o">,</span> <span class="n">pressure</span><span class="o">)</span>
    <span class="n">forecastDisplay</span><span class="o">.</span><span class="n">update</span><span class="o">(</span><span class="n">temp</span><span class="o">,</span> <span class="n">humidity</span><span class="o">,</span> <span class="n">pressure</span><span class="o">)</span>
  <span class="o">}</span>

<span class="o">}</span>
</pre>


<h3>Solution round 1: bad data encapsulation</h3>
<p>Note the Double temperature is passed everywhere!</p>
<pre class="code literal-block"><span class="k">trait</span> <span class="nc">DisplayElement</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">display</span><span class="k">:</span><span class="kt">Unit</span>
<span class="o">}</span>

<span class="k">trait</span> <span class="nc">Observer</span><span class="o">{</span>
  <span class="k">def</span> <span class="n">update</span><span class="o">(</span><span class="n">temp</span><span class="k">:</span><span class="kt">Double</span><span class="o">)</span><span class="k">:</span><span class="kt">Unit</span>
<span class="o">}</span>

<span class="k">trait</span> <span class="nc">Subject</span> <span class="o">{</span>

  <span class="k">val</span> <span class="n">observers</span><span class="k">:</span><span class="kt">ListBuffer</span><span class="o">[</span><span class="kt">Observer</span><span class="o">]</span> <span class="k">=</span> <span class="nc">ListBuffer</span><span class="o">[</span><span class="kt">Observer</span><span class="o">]()</span>

  <span class="k">def</span> <span class="n">registerObserver</span><span class="o">(</span><span class="n">observer</span><span class="k">:</span> <span class="kt">Observer</span><span class="o">)</span> <span class="k">=</span> <span class="n">observers</span> <span class="o">+=</span> <span class="n">observer</span>

  <span class="k">def</span> <span class="n">removeObserver</span><span class="o">(</span><span class="n">observer</span><span class="k">:</span> <span class="kt">Observer</span><span class="o">)</span> <span class="k">=</span> <span class="n">observers</span><span class="o">.</span><span class="n">remove</span><span class="o">(</span><span class="n">observers</span><span class="o">.</span><span class="n">indexOf</span><span class="o">(</span><span class="n">observer</span><span class="o">))</span>

  <span class="k">def</span> <span class="n">notifyObservers</span><span class="o">(</span><span class="n">temp</span><span class="k">:</span><span class="kt">Double</span><span class="o">)</span><span class="k">:</span><span class="kt">Unit</span>
<span class="o">}</span>

<span class="k">class</span> <span class="nc">WeatherStation</span> <span class="k">extends</span> <span class="nc">Subject</span><span class="o">{</span>

  <span class="k">var</span> <span class="n">temperature</span><span class="k">:</span><span class="kt">Double</span> <span class="o">=</span> <span class="mf">0.0</span>

  <span class="k">def</span> <span class="n">notifyObservers</span><span class="o">(</span><span class="n">temp</span><span class="k">:</span><span class="kt">Double</span><span class="o">)</span> <span class="k">=</span> <span class="n">observers</span><span class="o">.</span><span class="n">foreach</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">update</span><span class="o">(</span><span class="n">temp</span><span class="o">))</span>

  <span class="k">def</span> <span class="n">setMeasurement</span><span class="o">(</span><span class="n">temp</span><span class="k">:</span><span class="kt">Double</span><span class="o">)</span> <span class="k">=</span> <span class="o">{</span>
    <span class="n">temperature</span> <span class="k">=</span> <span class="n">temp</span>
    <span class="n">notifyObservers</span><span class="o">(</span><span class="n">temp</span><span class="o">)</span>
  <span class="o">}</span>

<span class="o">}</span>


<span class="k">class</span> <span class="nc">CurrentConditionDisplay</span><span class="o">(</span><span class="n">subject</span><span class="k">:</span> <span class="kt">Subject</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">Observer</span> <span class="k">with</span> <span class="nc">DisplayElement</span><span class="o">{</span>
  <span class="c1">// we're passing the subject in constructor so that we can call its register methods and other methods for pull</span>

  <span class="n">subject</span><span class="o">.</span><span class="n">registerObserver</span><span class="o">(</span><span class="k">this</span><span class="o">)</span>

  <span class="k">var</span> <span class="n">temperature</span><span class="k">:</span><span class="kt">Double</span> <span class="o">=</span> <span class="mf">0.0</span>

  <span class="k">def</span> <span class="n">display</span> <span class="k">=</span> <span class="n">println</span><span class="o">(</span><span class="s">s"current condition display, temperature: </span><span class="si">$temperature</span><span class="s">"</span><span class="o">)</span>

  <span class="k">def</span> <span class="n">update</span><span class="o">(</span><span class="n">temp</span><span class="k">:</span><span class="kt">Double</span><span class="o">)</span> <span class="k">=</span> <span class="o">{</span>
    <span class="n">temperature</span> <span class="k">=</span> <span class="n">temp</span>
    <span class="n">display</span>
  <span class="o">}</span>

  <span class="c1">// NOTE: if using the pull model, would be something like this: </span>

  <span class="k">def</span> <span class="n">update</span> <span class="k">=</span> <span class="o">{</span>
    <span class="n">temperature</span> <span class="k">=</span> <span class="n">subject</span><span class="o">.</span><span class="n">asInstanceOf</span><span class="o">[</span><span class="kt">WeatherStation</span><span class="o">].</span><span class="n">temperature</span>
    <span class="n">display</span>
  <span class="o">}</span>

<span class="o">}</span>

<span class="k">object</span> <span class="nc">Main</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">main</span><span class="o">(</span><span class="n">args</span><span class="k">:</span><span class="kt">Array</span><span class="o">[</span><span class="kt">String</span><span class="o">])</span><span class="k">:</span><span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
    <span class="k">val</span> <span class="n">station</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">WeatherStation</span>
    <span class="k">val</span> <span class="n">display</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">CurrentConditionDisplay</span><span class="o">(</span><span class="n">station</span><span class="o">)</span>

    <span class="n">station</span><span class="o">.</span><span class="n">setMeasurement</span><span class="o">(</span><span class="mf">10.0</span><span class="o">)</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre>


<h3>Solution round 2: better data encapsulation</h3>
<p>The <code>java.util.Observer</code> use <code>Object</code> type to pass data around: <code>update(Observable o, Object arg)</code></p>
<p>All the others the same, but we encapsulate data: </p>
<p>Note: scala's trait proves superior again as you can have concrete implementation but still can compose (as opposed to in Java, it uses a class for <code>Observable</code>, thus limiting its reuse potential)</p>
<pre class="code literal-block"><span class="c1">// DisplayElement and Main stays the same</span>

<span class="k">trait</span> <span class="nc">Data</span>

<span class="k">trait</span> <span class="nc">Observer</span><span class="o">{</span>
  <span class="k">def</span> <span class="n">update</span><span class="o">(</span><span class="n">subject</span><span class="k">:</span> <span class="kt">Subject</span><span class="o">,</span> <span class="n">data</span><span class="k">:</span> <span class="kt">Data</span><span class="o">)</span><span class="k">:</span><span class="kt">Unit</span> <span class="c1">// note we pass both subject (so that observers can also use pull model) and data here</span>
<span class="o">}</span>

<span class="k">trait</span> <span class="nc">Subject</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">observers</span><span class="k">:</span><span class="kt">ListBuffer</span><span class="o">[</span><span class="kt">Observer</span><span class="o">]</span> <span class="k">=</span> <span class="nc">ListBuffer</span><span class="o">[</span><span class="kt">Observer</span><span class="o">]()</span>

  <span class="k">def</span> <span class="n">registerObserver</span><span class="o">(</span><span class="n">observer</span><span class="k">:</span> <span class="kt">Observer</span><span class="o">)</span> <span class="k">=</span> <span class="n">observers</span> <span class="o">+=</span> <span class="n">observer</span>

  <span class="k">def</span> <span class="n">removeObserver</span><span class="o">(</span><span class="n">observer</span><span class="k">:</span> <span class="kt">Observer</span><span class="o">)</span> <span class="k">=</span> <span class="n">observers</span><span class="o">.</span><span class="n">remove</span><span class="o">(</span><span class="n">observers</span><span class="o">.</span><span class="n">indexOf</span><span class="o">(</span><span class="n">observer</span><span class="o">))</span>

 <span class="k">def</span> <span class="n">notifyObservers</span><span class="o">(</span><span class="n">data</span><span class="k">:</span> <span class="kt">Data</span><span class="o">)</span><span class="k">:</span><span class="kt">Unit</span> <span class="c1">// we pass data to all observers</span>
<span class="o">}</span>

<span class="k">case</span> <span class="k">class</span> <span class="nc">WeatherData</span> <span class="o">(</span><span class="n">temperature</span><span class="k">:</span><span class="kt">Double</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">Data</span>

<span class="k">class</span> <span class="nc">WeatherStation</span> <span class="k">extends</span> <span class="nc">Subject</span><span class="o">{</span>

  <span class="k">var</span> <span class="n">temperature</span><span class="k">:</span><span class="kt">Double</span> <span class="o">=</span> <span class="mf">0.0</span>

  <span class="k">def</span> <span class="n">notifyObservers</span><span class="o">(</span><span class="n">data</span><span class="k">:</span> <span class="kt">Data</span><span class="o">)</span> <span class="k">=</span> <span class="n">observers</span><span class="o">.</span><span class="n">foreach</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">update</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">data</span><span class="o">))</span> 

  <span class="k">def</span> <span class="n">setMeasurement</span><span class="o">(</span><span class="n">temp</span><span class="k">:</span><span class="kt">Double</span><span class="o">)</span> <span class="k">=</span> <span class="o">{</span>
    <span class="n">temperature</span> <span class="k">=</span> <span class="n">temp</span>
    <span class="n">notifyObservers</span><span class="o">(</span><span class="nc">WeatherData</span><span class="o">(</span><span class="n">temp</span><span class="o">))</span>
  <span class="o">}</span>

<span class="o">}</span>

<span class="k">class</span> <span class="nc">CurrentConditionDisplay</span><span class="o">(</span><span class="n">subject</span><span class="k">:</span> <span class="kt">Subject</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">Observer</span> <span class="k">with</span> <span class="nc">DisplayElement</span><span class="o">{</span>

  <span class="n">subject</span><span class="o">.</span><span class="n">registerObserver</span><span class="o">(</span><span class="k">this</span><span class="o">)</span>

  <span class="k">var</span> <span class="n">temperature</span><span class="k">:</span><span class="kt">Double</span> <span class="o">=</span> <span class="mf">0.0</span>

  <span class="k">def</span> <span class="n">display</span> <span class="k">=</span> <span class="n">println</span><span class="o">(</span><span class="s">s"current condition display, temperature: </span><span class="si">$temperature</span><span class="s">"</span><span class="o">)</span>

  <span class="k">def</span> <span class="n">update</span><span class="o">(</span><span class="n">subject</span><span class="k">:</span> <span class="kt">Subject</span><span class="o">,</span> <span class="n">data</span><span class="k">:</span> <span class="kt">Data</span><span class="o">)</span> <span class="k">=</span> <span class="o">{</span>
    <span class="n">temperature</span> <span class="k">=</span> <span class="n">data</span><span class="o">.</span><span class="n">asInstanceOf</span><span class="o">[</span><span class="kt">WeatherData</span><span class="o">].</span><span class="n">temperature</span> <span class="c1">// we need to cast to WeatherData</span>
    <span class="n">display</span>
  <span class="o">}</span>

<span class="o">}</span>
</pre>


<h3>Design Principle</h3>
<p>Strive for loosely coupled designs between objects that interact. </p>
<h3>Others</h3>
<ul>
<li>
<code>push</code> and <code>pull</code> style </li>
<li>
<code>java.util.Observer</code> also has a <code>setChanged()</code> method to control notifications.</li>
<li>Never depend on a specific notification order.</li>
</ul>
</div>
    </div>
    </article><article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="posts/design-pattern-1-strategy-pattern.html" class="u-url">Design pattern #1: Strategy Pattern</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn">
                Xiayun Sun
            </span></p>
            <p class="dateline"><a href="posts/design-pattern-1-strategy-pattern.html" rel="bookmark"><time class="published dt-published" datetime="2015-10-23T18:30:45+08:00" title="2015-10-23 18:30">2015-10-23 18:30</time></a></p>
                <p class="commentline">
        
    <a href="posts/design-pattern-1-strategy-pattern.html#disqus_thread" data-disqus-identifier="cache/posts/design-pattern-1-strategy-pattern.html">Comments</a>


        </p>
</div>
    </header><div class="e-content entry-content">
    <div>
<p>This is my notes about the book <a href="http://shop.oreilly.com/product/9780596007126.do">Head first design patterns</a>.</p>
<h3>Overview</h3>
<p>Strategy pattern: encapsulating behaviors / algorithms.</p>
<h3>Starting example</h3>
<p>We start with a duck base class and several concrete duck classes: </p>
<pre class="code literal-block"><span class="k">abstract</span> <span class="k">class</span> <span class="nc">Duck</span> <span class="o">{</span>

  <span class="k">def</span> <span class="n">quack</span><span class="k">:</span><span class="kt">Unit</span> <span class="o">=</span> <span class="n">println</span><span class="o">(</span><span class="s">"quack"</span><span class="o">)</span>

  <span class="k">def</span> <span class="n">display</span><span class="k">:</span><span class="kt">Unit</span>

<span class="o">}</span>

<span class="k">class</span> <span class="nc">RedDuck</span> <span class="k">extends</span> <span class="nc">Duck</span><span class="o">{</span>
  <span class="k">def</span> <span class="n">display</span><span class="k">:</span><span class="kt">Unit</span> <span class="o">=</span> <span class="n">println</span><span class="o">(</span><span class="s">"RedDuck"</span><span class="o">)</span>
<span class="o">}</span>

<span class="k">class</span> <span class="nc">RubberDuck</span> <span class="k">extends</span> <span class="nc">Duck</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">display</span><span class="k">:</span><span class="kt">Unit</span> <span class="o">=</span> <span class="n">println</span><span class="o">(</span><span class="s">"rubber duck"</span><span class="o">)</span>
<span class="o">}</span>
</pre>


<p>Now we want to add fly behavior, but <strong><em>only to some of the ducks</em></strong>. </p>
<p>Inheritance is not the right solution, because it'll add <code>fly</code> to all subclasses. </p>
<h3>General problem:</h3>
<p>Duck behavior keeps changing across subclasses, and it's not appropriate for <em>all</em> subclasses to have those behaviors</p>
<h3>Book's solution:</h3>
<p>Encapsulate <strong><em>behavior</em></strong> in classes. And assign behavior to the instances of Duck, and able to change dynamically.</p>
<pre class="code literal-block"><span class="k">trait</span> <span class="nc">FlyBehavior</span><span class="o">{</span>
  <span class="k">def</span> <span class="n">fly</span><span class="k">:</span><span class="kt">Unit</span>
<span class="o">}</span>

<span class="k">class</span> <span class="nc">FlyWithWings</span> <span class="k">extends</span> <span class="nc">FlyBehavior</span><span class="o">{</span>
  <span class="k">def</span> <span class="n">fly</span> <span class="k">=</span> <span class="n">println</span><span class="o">(</span><span class="s">"fly with wings"</span><span class="o">)</span>
<span class="o">}</span>

<span class="k">class</span> <span class="nc">FlyNoWay</span> <span class="k">extends</span> <span class="nc">FlyBehavior</span><span class="o">{</span>
  <span class="k">def</span> <span class="n">fly</span> <span class="k">=</span> <span class="o">()</span> <span class="c1">// do nothing</span>
<span class="o">}</span>


<span class="k">abstract</span> <span class="k">class</span> <span class="nc">Duck</span>
<span class="o">{</span>

  <span class="k">val</span> <span class="n">flyBehavior</span><span class="k">:</span><span class="kt">FlyBehavior</span> <span class="c1">// use super type here,</span>

  <span class="c1">// NOTE: we can also use var for flyBehavior and a setter method to change behavior in runtime</span>

  <span class="k">def</span> <span class="n">performFly</span><span class="k">:</span><span class="kt">Unit</span> <span class="o">=</span> <span class="n">flyBehavior</span><span class="o">.</span><span class="n">fly</span> <span class="c1">// delegate to behavior class</span>

  <span class="k">def</span> <span class="n">display</span><span class="k">:</span><span class="kt">Unit</span>

<span class="o">}</span>


<span class="k">class</span> <span class="nc">RedDuck</span> <span class="k">extends</span> <span class="nc">Duck</span><span class="o">{</span>

  <span class="k">val</span> <span class="n">flyBehavior</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">FlyWithWings</span>

  <span class="k">def</span> <span class="n">display</span><span class="k">:</span><span class="kt">Unit</span> <span class="o">=</span> <span class="n">println</span><span class="o">(</span><span class="s">"RedDuck"</span><span class="o">)</span>
<span class="o">}</span>

<span class="k">class</span> <span class="nc">RubberDuck</span> <span class="k">extends</span> <span class="nc">Duck</span> <span class="o">{</span>

  <span class="k">val</span> <span class="n">flyBehavior</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">FlyNoWay</span> <span class="c1">// rubber duck cannot fly</span>

  <span class="k">def</span> <span class="n">display</span><span class="k">:</span><span class="kt">Unit</span> <span class="o">=</span> <span class="n">println</span><span class="o">(</span><span class="s">"rubber duck"</span><span class="o">)</span>
<span class="o">}</span>

<span class="k">object</span> <span class="nc">Main</span><span class="o">{</span>
  <span class="k">def</span> <span class="n">main</span><span class="o">(</span><span class="n">args</span><span class="k">:</span><span class="kt">Array</span><span class="o">[</span><span class="kt">String</span><span class="o">])</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">={</span>
    <span class="k">val</span> <span class="n">redDuck</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">RedDuck</span>
    <span class="n">redDuck</span><span class="o">.</span><span class="n">performFly</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre>


<h3>Design principle:</h3>
<ul>
<li>Identify the aspects of your application that vary and separate them from what stays the same. (In this case, behavior is what varies)</li>
<li>Program to an interface/supertype, not an implementation. (Use interface for behaviors)</li>
<li>Favor composition over inheritance: "HAS-A" rather than "IS-A"</li>
</ul>
<h3>Pattern definition:</h3>
<p>Strategy pattern defines a family of algorithms, encapsulates each one, and makes them interchangeable. Strategy lets the algorithm vary independently from clients that use it. </p>
<p>In our example, behavior is our "algorithm"</p>
<h3>Other notes:</h3>
<ul>
<li>The importance of having a shared vocabulary</li>
<li>OO basics: abstraction; encapsulation; polymorphism; inheritance</li>
</ul>
<h3>How about using traits?</h3>
<p>Unlike interface in Java, traits in scala can have concrete implementations, so we have code reuse. </p>
<p>Compared to book's solution, however, I'm unable to update the behavior in runtime. </p>
<pre class="code literal-block"><span class="k">abstract</span> <span class="k">class</span> <span class="nc">Duck</span> <span class="o">{</span>

  <span class="k">def</span> <span class="n">quack</span><span class="k">:</span><span class="kt">Unit</span> <span class="o">=</span> <span class="n">println</span><span class="o">(</span><span class="s">"quack"</span><span class="o">)</span>

  <span class="k">def</span> <span class="n">display</span><span class="k">:</span><span class="kt">Unit</span>

<span class="o">}</span>

<span class="k">trait</span> <span class="nc">FlyableDuck</span><span class="o">{</span>
  <span class="k">def</span> <span class="n">fly</span> <span class="k">=</span> <span class="n">println</span><span class="o">(</span><span class="s">"flying!"</span><span class="o">)</span>
<span class="o">}</span>

<span class="k">class</span> <span class="nc">RedDuck</span> <span class="k">extends</span> <span class="nc">Duck</span> <span class="k">with</span> <span class="nc">FlyableDuck</span><span class="o">{</span>
  <span class="k">def</span> <span class="n">display</span><span class="k">:</span><span class="kt">Unit</span> <span class="o">=</span> <span class="n">println</span><span class="o">(</span><span class="s">"RedDuck"</span><span class="o">)</span>
<span class="o">}</span>

<span class="k">class</span> <span class="nc">RubberDuck</span> <span class="k">extends</span> <span class="nc">Duck</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">display</span><span class="k">:</span><span class="kt">Unit</span> <span class="o">=</span> <span class="n">println</span><span class="o">(</span><span class="s">"rubber duck"</span><span class="o">)</span>
<span class="o">}</span>
</pre>
</div>
    </div>
    </article><article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="posts/1-1-1.html" class="u-url">1 * '1' = '1'</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn">
                Xiayun Sun
            </span></p>
            <p class="dateline"><a href="posts/1-1-1.html" rel="bookmark"><time class="published dt-published" datetime="2014-12-04T21:36:49+08:00" title="2014-12-04 21:36">2014-12-04 21:36</time></a></p>
                <p class="commentline">
        
    <a href="posts/1-1-1.html#disqus_thread" data-disqus-identifier="cache/posts/1-1-1.html">Comments</a>


        </p>
</div>
    </header><div class="e-content entry-content">
    <div>
<p>There are some days I wish Python is strongly typed. And today is one of them. </p>
<h4>Background</h4>
<p>I work on an algorithm trading desk. Our algorithm trading engine is in Python. For a few days my team has been working on a new feature which can assign a "weight" to each trading strategy, so for example if a strategy has a weight of 2, then each trading order it sends will automatically has its size doubled up. </p>
<p>Last night the development work was done. I run the tests, merged back to development branch, and deployed to our simulation environment. </p>
<p>This morning when I came into office, I was greeted by an error: basically it was shouting at me that the volume field in an order should be a number, not a string. </p>
<p>This has never happened before. </p>
<h4>What happened</h4>
<p>My first instinct is I could just add a simple <code>int()</code> wrapper around the volume field and back to my breakfast. Luckily I didn't and instead sat down to find the bug. </p>
<p>It turns out as we're reading the weights from a config file, but without properly converting it into an integer, so the weight stays as a string and everytime it's applied to order volume, Python won't complain about type mismatch, instead something like below happens:</p>
<pre class="code literal-block"><span class="mi">1</span> <span class="o">*</span> <span class="s">'1'</span> <span class="o">=</span> <span class="s">'1'</span>
</pre>


<p>And an order with size '1', not number 1 is sent. </p>
<h4>Why didn't my tests fail?</h4>
<p>We have both unit tests and integration tests (where a dummy strategy will run throught the whole market data --&gt; trading signal --&gt; trading execution process). </p>
<p>In this case I didn't update the integration tests to include the weight. And in our code the default weight is 1 (NOTE: not '1'), so the tests happily passed. </p>
<h4>Remediation</h4>
<p>Just add an <code>int()</code> coersion when reading the weight from the config file. </p>
<p>I also included the weight field in my tests. </p>
<h4>The real danger</h4>
<p>It only occurred to me in the afternoon that if this has not been properly fixed, real disaster could happen: </p>
<p>Imagine a strategy with weight = 1 emits a trading signal with size = 3: </p>
<pre class="code literal-block"><span class="mi">3</span> <span class="o">*</span> <span class="s">'1'</span> <span class="o">=</span> <span class="s">'111'</span>
<span class="nb">int</span><span class="p">(</span><span class="s">'111'</span><span class="p">)</span> <span class="o">=</span> <span class="mi">111</span>  <span class="c">#ahhhh fat finger</span>
</pre>


<p>Now I don't even want to think about what <code>5 * '1'</code> would turn out. </p>
<h4>Takeaways</h4>
<ul>
<li>NEVER blindly coerce types.</li>
<li>Always update tests with new features. </li>
<li>It's important to trace down to the root cause of a bug. </li>
</ul>
</div>
    </div>
    </article><article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="posts/selenium-auto-tests-on-server.html" class="u-url">Running automated selenium tests on Debian server</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn">
                Xiayun Sun
            </span></p>
            <p class="dateline"><a href="posts/selenium-auto-tests-on-server.html" rel="bookmark"><time class="published dt-published" datetime="2014-09-21T13:11:27+08:00" title="2014-09-21 13:11">2014-09-21 13:11</time></a></p>
                <p class="commentline">
        
    <a href="posts/selenium-auto-tests-on-server.html#disqus_thread" data-disqus-identifier="cache/posts/selenium-auto-tests-on-server.html">Comments</a>


        </p>
</div>
    </header><div class="e-content entry-content">
    <div>
<p>In the startup I work we use <a href="http://www.seleniumhq.org/">selenium</a> for automated web testing. Previously the testing flow involves manually open the selenium plugin in firefox, set the environment-specific variables and click the "Play entire test suite" button. Recently I migrated the task to a Debian server which frees us from manual work and enables us to do much more, eg. test scheduling, integrating to the deployment process, etc. </p>
<p>Below is my notes on achieving this.</p>
<h4>Running selenium headless</h4>
<p>Selenium normally requires a display. On a Linux server, I use <a href="http://www.x.org/archive/X11R7.7/doc/man/man1/Xvfb.1.xhtml">xvfb</a> to simulate the display. The command is:</p>
<pre class="code literal-block">xvfb-run --server-num<span class="o">=</span><span class="m">10</span> &lt;python commands here&gt;
</pre>


<p>eg:</p>
<pre class="code literal-block">xvfb-run --server-num<span class="o">=</span><span class="m">10</span> python -m unittest discover --pattern<span class="o">=</span>*.py
</pre>


<p>I have also found out that the method <code>driver.find_element_by_link_text</code> often fails with the message "cannot scroll into view". I have tried the fix with <code>maximize_window</code> and <code>window.scrollTo(x, y)</code> but with no luck. In the end I have to replace some of the clicks with <code>driver.get(url)</code> calls. </p>
<h4>POST request in logged in session</h4>
<p>Selenium does not support POST request naturally (if it does please let me know!), this is a bit of headache when some jquery POST calls need to be tested within a logged in session. </p>
<p>Luckily we use cookies to verify logged in sessions and thus can have the super awesome <a href="http://docs.python-requests.org/en/latest/">requests</a> library to the rescue.</p>
<p>The tricky part(I am not sure if it is a universal case) is that when I login through POST request to our authenticate service, the returned cookie cannot be found in the <code>request.cookies</code>, rather it is part of the <code>r.request.headers['Cookie']</code>. </p>
<p>So for example to test the <code>like</code> button in a post (something similar to the facebook <code>like</code> button):</p>
<pre class="code literal-block"><span class="c"># step1 login</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">authen_url</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s">'username'</span><span class="p">:</span> <span class="n">username</span><span class="p">,</span> <span class="s">'password'</span><span class="p">:</span> <span class="n">password</span><span class="p">})</span>

<span class="c"># get cookie from headers </span>
<span class="c"># note r.request.headers['Cookie'] is a comma separated string</span>
<span class="c"># eg: name1=val1; name2=val2</span>
<span class="n">cookie_str</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s">'Cookie'</span><span class="p">]</span>
<span class="n">cookies</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cookie_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">';'</span><span class="p">):</span>
    <span class="n">cname</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">'='</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">cval</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">'='</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">cookies</span><span class="p">[</span><span class="n">cname</span><span class="p">]</span> <span class="o">=</span> <span class="n">cval</span>

<span class="c"># step2 test other functions with the obtained cookie</span>
<span class="c"># eg. a "like" POST function here</span>
<span class="n">u</span> <span class="o">=</span> <span class="s">'domain.com/service/likefeed'</span>
<span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="s">'feedid'</span><span class="p">:</span><span class="n">feedid</span><span class="p">}</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">d</span><span class="p">,</span> <span class="n">cookies</span> <span class="o">=</span> <span class="n">cookies</span><span class="p">)</span>

<span class="c"># step3 use selenium to test frontend effect, eg. a thumbs up symbol</span>
<span class="c"># selenium webdriver functions here</span>
</pre>


<h4>Supporting different environments</h4>
<p>We have 3 sets of development environments (demo --&gt; pilot --&gt; production). To switch among these 3 seamlessly, I created a <code>config.ini</code> file writing down the environment-specific variables (eg. base URL, test account login, test post contents, etc.) for each environment, and pass this config (using the excellent <a href="https://pypi.python.org/pypi/configobj">configobj</a> module) when initializing each test suite:</p>
<p>So I have a utility function like below:</p>
<pre class="code literal-block"><span class="c">#utils.py</span>

<span class="kn">from</span> <span class="nn">configobj</span> <span class="kn">import</span> <span class="n">ConfigObj</span>

<span class="k">def</span> <span class="nf">read_env</span><span class="p">(</span><span class="n">env</span><span class="p">):</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">ConfigObj</span><span class="p">(</span><span class="s">'config.ini'</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">env</span><span class="p">,</span> <span class="n">c</span><span class="p">[</span><span class="n">env</span> <span class="o">+</span> <span class="s">'_baseurl'</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="n">env</span> <span class="o">+</span> <span class="s">'_account'</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="n">env</span> <span class="o">+</span> <span class="s">'_passwd'</span><span class="p">]</span>
</pre>


<p>Then in each test suite script I add a customized <code>__init__</code> call that will initialize properties to respective values according to the passed environment, these values can then be used in later testing functions:</p>
<p>For example:</p>
<pre class="code literal-block"><span class="c"># test_suite_1.py</span>

<span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">read_env</span>

<span class="k">class</span> <span class="nc">TestSuite1</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TestSuite1</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="s">'test_case_1'</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">account</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">passwd</span> <span class="o">=</span> <span class="n">read_env</span><span class="p">(</span><span class="n">en</span><span class="p">)</span>
</pre>


<p>Then I have a master file controlling the complete test run:</p>
<pre class="code literal-block"><span class="c"># run.py</span>

<span class="kn">from</span> <span class="nn">test_suite_1</span> <span class="kn">import</span> <span class="n">TestSuite1</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">env</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">suite</span> <span class="o">=</span> <span class="n">unittest</span><span class="o">.</span><span class="n">TestSuite</span><span class="p">()</span>

    <span class="n">suite</span><span class="o">.</span><span class="n">addTest</span><span class="p">(</span><span class="n">TestSuite1</span><span class="p">(</span><span class="n">env</span><span class="p">))</span> <span class="c"># initialize with specific env</span>

    <span class="n">unittest</span><span class="o">.</span><span class="n">TextTestRunner</span><span class="p">()</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">suite</span><span class="p">)</span>
</pre>


<p>To make things easier I also add a bash alias in <code>.bash_aliases</code>:</p>
<pre class="code literal-block"><span class="nb">alias </span><span class="nv">mftest</span> <span class="o">=</span> <span class="s1">'xvfb-run --server-num=10 python /path/to/tests/run.py'</span>
</pre>


<p>In this way the complete test process can be kicked off by simply running <code>mftest &lt;env&gt;</code> where <code>&lt;env&gt;</code> can be either <code>demo</code> or <code>pilot</code> or <code>prod</code>, and the program will pick up the right config.</p>
</div>
    </div>
    </article><article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="posts/how-to-insert-pictures-into-posts-in-nikola.html" class="u-url">How to insert images into posts in Nikola</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn">
                Xiayun Sun
            </span></p>
            <p class="dateline"><a href="posts/how-to-insert-pictures-into-posts-in-nikola.html" rel="bookmark"><time class="published dt-published" datetime="2014-05-19T00:19:35+08:00" title="2014-05-19 00:19">2014-05-19 00:19</time></a></p>
                <p class="commentline">
        
    <a href="posts/how-to-insert-pictures-into-posts-in-nikola.html#disqus_thread" data-disqus-identifier="cache/posts/how-to-insert-pictures-into-posts-in-nikola.html">Comments</a>


        </p>
</div>
    </header><div class="e-content entry-content">
    <div>
<p>Since it took me a surprisingly long time to solve this simple problem -- it's not in Nikola's <a href="http://getnikola.com/handbook.html">official docs</a>(where they only have a section on galleries) and my Google search was unfruitful, I thought I'd write it down.</p>
<p>The simple trick is based on the fact that Nikola will automatically copy all contents under <code>files/</code> folder to <code>output/</code> folder when you run <code>nikola build</code>.</p>
<p>So here are the steps:</p>
<ol>
<li>
<p>Create a subdirectory in <code>files/</code>. Say <code>regex_pic/</code> (where I put my images for the previous post on <a href="http://xysun.github.io/posts/regex-parsing-thompsons-algorithm.html">parsing regex</a>) -- this is more about better practice, since I don't like to clutter my <code>output/</code> folder. </p>
</li>
<li>
<p>Put your images into that folder. </p>
</li>
<li>
<p>In your post, use regular markdown syntax to reference those images. For example: <code>![simple image1](/regex_pic/simple1.jpg)</code> will insert <code>regex_pic/simple1.jpg</code>. </p>
</li>
<li>
<p><code>nikola build</code>. Done.</p>
</li>
</ol>
</div>
    </div>
    </article><article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="posts/regex-parsing-thompsons-algorithm.html" class="u-url">Regex parsing: Thompson's algorithm</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn">
                Xiayun Sun
            </span></p>
            <p class="dateline"><a href="posts/regex-parsing-thompsons-algorithm.html" rel="bookmark"><time class="published dt-published" datetime="2014-05-18T22:26:11+08:00" title="2014-05-18 22:26">2014-05-18 22:26</time></a></p>
                <p class="commentline">
        
    <a href="posts/regex-parsing-thompsons-algorithm.html#disqus_thread" data-disqus-identifier="cache/posts/regex-parsing-thompsons-algorithm.html">Comments</a>


        </p>
</div>
    </header><div class="e-content entry-content">
    <div>
<p>This is a repost of my previous blog article at the old domain. </p>
<p>Source code can be found <a href="https://github.com/xysun/regex">here</a></p>
<h3>Theory</h3>
<p>The central idea behind a regex engine is non-deterministic automata, NFA. While the name is scary, it is just a state machine which can transit to other state machines on certain characters or nothing (which is called an "epsilon transition")</p>
<p>For example, below is an NFA for the simple concatenation regex <code>ab</code>: </p>
<p><img alt="simple regex1" src="regex_pic/simple1.jpg"></p>
<p><code>s0</code> is the start state. It can accept one character 'a' and transform to state <code>s1</code>. Similarly <code>s1</code> can only accept one character 'b' and transfer to state <code>s2</code>. <code>s2</code> is the final state, if we have exhausted the input string and the current state is a final state, the pattern matching is successful. </p>
<p>Below is a slightly more complicated example, matching <code>a?a</code>: </p>
<p><img alt="simple regex2" src="regex_pic/simple2.jpg"></p>
<p>Here the transition with an epsilon means a state can transform into the next state without any input. Therefore this combined NFA matches both <code>aa</code> and <code>a</code>, i.e. <code>a?a</code>. </p>
<p>To build a regex engine is just to build an NFA corresponding to the input regex pattern, which can be done similarly as parsing arithmetic expressions, i.e. push individual NFAs for individual characters onto a stack, upon seeing an operator, eg star/question mark/alternation/concatenation, pop NFAs from the stack, connecting the popped NFAs to form a new NFA and push back onto the stack again. </p>
<p>I recommend these two excellent articles on NFA. <a href="http://perl.plover.com/Regex/article.html">1. How Regexes Work </a> <a href="http://swtch.com/~rsc/regexp/regexp1.html">2. Regular Expression Matching Can be Simple and Fast</a></p>
<h3>Thompson's algorithm</h3>
<p>The difference between Thompson's algorithm and the current backtracking implementation in Python/Ruby/... lies in the treatment for multiple transitions. Backtracking algorithm tracks only one transition at one step (always choose the greedy transition) and backtrack to another route if current route fails, while Thompson's algorithm tracks all possible transitions simultaneously. </p>
<p>Take the above <code>a?a</code> for example, suppose we are matching an input string of <code>a</code> to this NFA. The backtracking algorithm will try the <code>a</code> transition from <code>s0</code> to <code>s1</code> first since it is greedy, but this route fails since input is exhausted at non-final state <code>s1</code>, so the algorithm backtracks to <code>s0</code> and choose the epsilon transition this time, and is able to arrive at the final state <code>s2</code> correctly. On the other hand, Thompson's algorithm will try to track both <code>a</code> and epsilon transition simultaneously. Before it reads anything, both <code>s0</code> and <code>s1</code> are considered as starting states since <code>s0</code> can transit into <code>s1</code> without any input. Now after reading the only character <code>a</code>, only <code>s1</code> will successfully transit into final state <code>s2</code>, and the matching completes. </p>
<p>This means Thompson's algorithm will significantly perform better over some pathological input patterns such as <code>a?a?a?aaa</code> matching <code>aaa</code>, since time complexity is exponential for backtracking algorithm and only linear for Thompson's algorithm.</p>
<h3>Code</h3>
<p>First step is to convert an input string into post-fix tokens, and add concatenation in the right place. A simple lexer and recursive-descent parser is used for this stage, following the grammar below (for detailed lexing and parsing code please refer to the source code):</p>
<pre class="code literal-block">Grammar for regex:

regex = exp $

exp      = term [|] exp      {push '|'}
         | term
         |                   empty?

term     = factor term       chain {add \x08}  # \x08 is used as CONCAT token
         | factor

factor   = primary [*]       star {push '*'}
         | primary [+]       plus {push '+'}
         | primary [?]       optional {push '?'}
         | primary

primary  = \( exp \)
         | char              literal {push char}
</pre>


<p>A very simple class is enough to simulate an NFA:</p>
<pre class="code literal-block"><span class="k">class</span> <span class="nc">State</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span> <span class="o">=</span> <span class="p">[]</span> <span class="c"># epsilon-closure</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transitions</span> <span class="o">=</span> <span class="p">{}</span> <span class="c"># a dictionary of char --&gt; state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_end</span> <span class="o">=</span> <span class="bp">False</span> <span class="c"># is it the ending state?</span>
</pre>


<p>Next we read one token at a time, perform relevant NFA transformations and push the transformed NFA onto a stack. For example, when seeing a CONCAT token, pop two NFAs from the stack, chain these two NFAs together and create a new CONCAT NFA, and push the new NFA onto the stack again. When all the tokens are consumed, there should be only one  NFA left on the stack. Details on how to construct NFAs can be found either from the two articles cited above, or from the book <a href="http://www.amazon.com/Compilers-Principles-Techniques-Tools-Edition/dp/0321486811">Compilers: Principles Techniques and Tools</a></p>
<p>A <code>handler</code> class is used for this step, the class has a dictionary of different handlers for each type of tokens. </p>
<pre class="code literal-block"><span class="k">class</span> <span class="nc">Handler</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span> <span class="o">=</span> <span class="p">{</span><span class="s">'CHAR'</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">handle_char</span><span class="p">,</span> <span class="s">'CONCAT'</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">handle_concat</span><span class="p">,</span>
                         <span class="s">'ALT'</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">handle_alt</span><span class="p">,</span> <span class="s">'STAR'</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">handle_rep</span><span class="p">,</span>
                         <span class="s">'PLUS'</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">handle_rep</span><span class="p">,</span> <span class="s">'QMARK'</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">handle_qmark</span><span class="p">}</span>
</pre>


<p>These steps above form the exposed <code>compile</code> function, which turns an input regex string into an NFA machine. </p>
<pre class="code literal-block"><span class="kn">from</span> <span class="nn">parse</span> <span class="kn">import</span> <span class="n">Lexer</span><span class="p">,</span> <span class="n">Parser</span><span class="p">,</span> <span class="n">Token</span><span class="p">,</span> <span class="n">State</span><span class="p">,</span> <span class="n">NFA</span><span class="p">,</span> <span class="n">Handler</span>

<span class="k">def</span> <span class="nf">compile</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">debug</span> <span class="o">=</span> <span class="bp">False</span><span class="p">):</span>

    <span class="n">lexer</span> <span class="o">=</span> <span class="n">Lexer</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">Parser</span><span class="p">(</span><span class="n">lexer</span><span class="p">)</span>
    <span class="n">tokens</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">()</span>

    <span class="n">handler</span> <span class="o">=</span> <span class="n">Handler</span><span class="p">()</span>

    <span class="n">nfa_stack</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">:</span>
        <span class="n">handler</span><span class="o">.</span><span class="n">handlers</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">name</span><span class="p">](</span><span class="n">t</span><span class="p">,</span> <span class="n">nfa_stack</span><span class="p">)</span>

    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">nfa_stack</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="c"># check there is only one final NFA on the stack</span>
    <span class="k">return</span> <span class="n">nfa_stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span> 
</pre>


<p>Next we can feed the constructed NFA a string and check whether it is accepted or not. The <code>match</code> function uses two <code>sets</code> to hold <code>current_state</code> and <code>next_state</code>, make each <code>char</code> transitions and epsilon transitions and check if any ending state is arrived:</p>
<pre class="code literal-block"><span class="k">def</span> <span class="nf">match</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">):</span>
       <span class="n">current_states</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">addstate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">current_states</span><span class="p">)</span> <span class="c"># addstate makes epsilon transitions</span>

       <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
           <span class="n">next_states</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
           <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">current_states</span><span class="p">:</span>
               <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">transitions</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                   <span class="n">trans_state</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">transitions</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">addstate</span><span class="p">(</span><span class="n">trans_state</span><span class="p">,</span> <span class="n">next_states</span><span class="p">)</span>

           <span class="n">current_states</span> <span class="o">=</span> <span class="n">next_states</span> 

       <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">current_states</span><span class="p">:</span> <span class="c">#check if any ending state reached, if so, return match</span>
           <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">is_end</span><span class="p">:</span>
               <span class="k">return</span> <span class="bp">True</span>
       <span class="k">return</span> <span class="bp">False</span>
</pre>


<h3>Performance</h3>
<p>Benchmarking with Python's built-in <code>re</code> module, over normal inputs (from <a href="http://www2.research.att.com/~gsf/testregex/">Glenn Fowler's test suite</a>, Python performs better, which is as expected since I didn't do any optimization. But the average speed is fast for both algorithms -- less than 1ms.</p>
<p><img alt="performance 1" src="regex_pic/plot_normal.jpg"></p>
<p>However, when tested with those pathological inputs, Thompson's algorithm is a clear win, specifically Python will hang when <code>n</code> is over 25. Notice the time scale is in seconds rather than in milliseconds in the previous plot. </p>
<p><img alt="performance 2" src="regex_pic/plot_path.jpg"></p>
<p>Russ Cox wrote about <a href="http://swtch.com/~rsc/regexp/regexp1.html">history behind regex implementation</a> (last section).</p>
</div>
    </div>
    </article>
</div>

        <nav class="postindexpager"><ul class="pager">
<li class="next">
                <a href="index-1.html" rel="next">Older posts</a>
            </li>
        </ul></nav><script>var disqus_shortname="nikolademo";(function(){var a=document.createElement("script");a.async=true;a.src="//"+disqus_shortname+".disqus.com/count.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}());</script>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2015         <a href="mailto:xiayunsun@gmail.com">Xiayun Sun</a> - Powered by         <a href="http://getnikola.com" rel="nofollow">Nikola</a>         
            
        </footer>
</div>
</div>


            <script src="assets/js/all-nocdn.js"></script><!-- Social buttons --><!--
<div id="addthisbox" class="addthis_toolbox addthis_peekaboo_style addthis_default_style addthis_label_style addthis_32x32_style">
<a class="addthis_button_more">Share</a>
<ul><li><a class="addthis_button_facebook"></a>
<li><a class="addthis_button_google_plusone_share"></a>
<li><a class="addthis_button_linkedin"></a>
<li><a class="addthis_button_twitter"></a>
</ul>
</div>
<script src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-4f7088a56bb93798"></script>
--><!-- End of social buttons --><script>$('a.image-reference:not(.islink) img:not(.islink)').parent().colorbox({rel:"gal",maxWidth:"100%",maxHeight:"100%",scalePhotos:true});</script><!-- fancy dates --><script>
    moment.locale("");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates -->
</body>
</html>
